name: Build PDF and Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup TeX Live
      uses: xu-cheng/latex-action@v3
      with:
        root_file: latex/book.tex
        latexmk_use_xelatex: true
        work_in_root_file_dir: true
        latexmk_use_lualatex: false
        latexmk_use_xelatex: false
        latexmk_use_pdflatex: true
        args: "-pdf -interaction=nonstopmode -synctex=1"
        
    - name: Upload PDF artifact
      uses: actions/upload-artifact@v4
      with:
        name: cpp-qt-book
        path: |
          *.pdf
          latex/*.pdf
        retention-days: 30
        
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: "C++ dan Qt Programming Guide ${{ steps.get_version.outputs.version }}"
        body: |
          # C++ dan Qt Programming Guide ${{ steps.get_version.outputs.version }}
          
          ## 📚 Tentang Buku Ini
          
          Buku panduan lengkap untuk belajar C++ dan Qt Framework. Dirancang khusus untuk pemula yang ingin menguasai pemrograman C++ dan pengembangan aplikasi dengan Qt.
          
          ## 🎯 Fitur Utama
          
          - **Pembelajaran Bertahap** - Dari dasar hingga lanjutan
          - **Contoh Kode Lengkap** - 333+ contoh program siap jalankan
          - **Qt Creator Integration** - IDE modern untuk development
          - **GUI Programming** - Membuat aplikasi dengan antarmuka grafis
          - **Database Integration** - SQLite dan MySQL
          - **Web Integration** - Qt WebKit untuk browser
          - **Debugging Guide** - Teknik debugging yang efektif
          - **Design Patterns** - Singleton, Observer, MVC
          
          ## 📖 Struktur Buku
          
          ### Part I: Dasar Pemrograman C++
          - Pengenalan C++ dan Qt Creator
          - Tipe data, variabel, dan operator
          - Control statement (if, switch, loop)
          - Array dan string manipulation
          - Fungsi dan modularisasi
          - Pointer dan references
          - Debugging techniques
          
          ### Part II: Object-Oriented Programming
          - Class dan object
          - Inheritance dan polymorphism
          - Operator overloading
          - Design patterns
          - Casting dan database
          
          ### Part III: Qt Library dan Komponen
          - Qt Library fundamentals
          - File, stream, dan XML
          - Qt WebKit integration
          
          ### Part IV: Antarmuka Pengguna
          - GUI programming dengan Qt
          - Signal dan slot
          - Layout management
          - Modern UI development
          
          ## 🚀 Cara Menggunakan
          
          1. **Download PDF** - Baca buku dalam format PDF
          2. **Install Qt Creator** - IDE untuk development
          3. **Praktik Kode** - Jalankan contoh program
          4. **Buat Project** - Terapkan konsep dalam project nyata
          
          ## 💻 Requirements
          
          - Qt Creator 5.15+ atau Qt 6.x
          - C++ compiler (GCC, MSVC, Clang)
          - Minimal 4GB RAM
          - Windows 10+, macOS 10.14+, atau Linux
          
          ## 📚 Referensi
          
          - [Qt Documentation](https://doc.qt.io/)
          - [C++ Reference](https://en.cppreference.com/)
          - [Qt Creator](https://www.qt.io/product/development-tools)
          
          ## 👨‍💻 Tentang Penulis
          
          **Nur Wachid** - Head of Software Engineering di PT. Lingkar Kreasi Teknologi
          
          - Website: https://www.wach.id
          - LinkedIn: [LinkedIn Profile]
          
          ## 📄 Lisensi
          
          Creative Commons Attribution-NonCommercial 4.0 International License
          
          ---
          
          *Selamat belajar dan happy coding! 🚀*
          
        files: |
          *.pdf
          latex/*.pdf
        draft: false
        prerelease: false
        
    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./latex/book.pdf
        asset_name: cpp-qt-programming-guide-${{ steps.get_version.outputs.version }}.pdf
        asset_content_type: application/pdf 